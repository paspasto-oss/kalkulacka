<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kalkulačka – Plyn vs. Tepelné čerpadlo</title>

<style>
  :root{ --brand:#D60000; --dark:#111; --bg:#F6F7F9; }
  html,body{margin:0;padding:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:#111}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .frame{background:#fff;border:1px solid #e6e6e6;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:20px}

  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:980px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:16px}
  h2{font-size:18px;margin:.2em 0 .6em}
  label{display:block;font-weight:700;margin-top:10px}
  input[type="number"], select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:15px;margin-top:4px}
  .muted{color:#666;font-size:13px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  tfoot td{font-weight:800}
  .right{text-align:right}
  .total{font-size:20px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .kpi .box{background:var(--bg);border:1px solid #e8e8e8;border-radius:12px;padding:12px}
  .kpi .box b{display:block;font-size:12px;color:#555}
  .kpi .box span{font-size:20px;font-weight:800}
  .cta{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:800;text-transform:uppercase;cursor:pointer}
  .btn.secondary{background:#444}

  /* print štýly (ak by niekto použil systémovú tlač) */
  @media print{
    .cta, .card input, .card select { display:none !important; }
    .grid{grid-template-columns:1fr !important}
    .wrap{max-width:900px}
    .frame{box-shadow:none;border:1px solid #ddd}
    .kpi .box{background:#fff}
    a{color:inherit;text-decoration:none}
  }
</style>

<!-- knižnice pre priamy export do PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
</head>
<body>
<div class="wrap">
  <div class="frame" id="exportArea">
    <div class="grid">
      <!-- PLYN -->
      <div class="card">
        <h2>1) Plyn – vstupy</h2>
        <label>Ročná spotreba plynu (m³)</label>
        <input id="gas_m3" type="number" min="0" step="1" value="1500">
        <div class="muted">Bežný rodinný dom: ~1200–2000 m³/rok</div>

        <label>Spodná výhrevnosť (kWh/m³)</label>
        <input id="calorific" type="number" min="8" max="12" step="0.1" value="10.5">
        <div class="muted">Typicky 10.2–10.8 kWh/m³</div>

        <label>Účinnosť kotla (%)</label>
        <input id="boiler_eff" type="number" min="50" max="105" step="1" value="90">
        <div class="muted">Kondenzačný kotol 88–98 %</div>

        <label>Cena plynu (€/m³)</label>
        <input id="gas_price" type="number" min="0" step="0.01" value="0.75">

        <label>Fixný mesačný poplatok plynu (€/mes.)</label>
        <input id="gas_fixed" type="number" min="0" step="0.01" value="5">
      </div>

      <!-- TČ -->
      <div class="card">
        <h2>2) Tepelné čerpadlo – vstupy</h2>
        <label>SCOP/COP</label>
        <select id="scop">
          <option value="2.8">2.8</option>
          <option value="3.2" selected>3.2</option>
          <option value="3.6">3.6</option>
          <option value="4.0">4.0</option>
        </select>

        <label>Cena elektriny (€/kWh)</label>
        <input id="elec_price" type="number" min="0" step="0.001" value="0.18">

        <label>Pokrytie FVE pre TČ (%)</label>
        <input id="pv" type="number" min="0" max="100" step="5" value="20">
        <div class="muted">Percento elektriny pre TČ pokryté fotovoltikou</div>

        <label>Investícia do TČ (€, voliteľné)</label>
        <input id="hp_invest" type="number" min="0" step="100" value="0">

        <label>Dotácia na TČ (€, voliteľné)</label>
        <input id="hp_subsidy" type="number" min="0" step="50" value="0">
      </div>

      <!-- VÝSLEDOK -->
      <div class="card" style="grid-column:1/-1">
        <h2>Výsledok</h2>
        <div class="kpi">
          <div class="box"><b>Plyn – energia</b><span id="gas_kwh">0 kWh</span></div>
          <div class="box"><b>Užitočné teplo</b><span id="heat_kwh">0 kWh</span></div>
          <div class="box"><b>TČ – el. spotreba</b><span id="hp_kwh">0 kWh</span></div>
        </div>

        <table style="margin-top:12px">
          <tbody id="rows"></tbody>
          <tfoot>
            <tr><td><b>Ročné náklady plynu (spolu)</b></td><td class="right" id="gas_total">0 €</td></tr>
            <tr><td><b>Ročné náklady TČ (spolu)</b></td><td class="right" id="hp_total">0 €</td></tr>
            <tr><td class="total">Ročná úspora s TČ</td><td class="right total" id="savings">0 €</td></tr>
          </tfoot>
        </table>

        <!-- Návratnosť priamo v UI -->
        <div class="kpi" style="grid-template-columns:1fr;margin-top:10px">
          <div class="box"><b>Odhad návratnosti investície</b><span id="payback_ui">–</span></div>
        </div>

        <div class="cta" id="buttonsRow">
          <!-- odstránené tlačidlo „Kopírovať výsledok“ -->
          <button class="btn" id="pdfBtn"  style="background:#0B5;">Stiahnuť PDF</button>
          <button class="btn secondary" id="resetBtn">Reset</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== KONFIG – PDF kontakt a vodotlač ===== */
  const COMPANY = {
    name: "SPEKTRA INSTALL",
    phone: "+421 917 572 221",
    email: "spektrainstall@gmail.com",
    web: "www.spektrainstall.sk",
    address: "Hollého 210"
  };
  const WATERMARK_URL = "https://michpas69.github.io/kalkulacka/1customcolor_logo_transparent_background.png";

  function eur(n){ return n.toLocaleString('sk-SK',{style:'currency',currency:'EUR'}); }
  function kwh(x){ return Math.round(x).toLocaleString('sk-SK') + ' kWh'; }
  function el(id){ return document.getElementById(id); }

  function calc(){
    var gas_m3   = +el('gas_m3').value||0;
    var H        = +el('calorific').value||10.5;    // kWh/m3
    var eff      = (+el('boiler_eff').value||90)/100;
    var gas_p    = +el('gas_price').value||0;
    var gas_fix  = +el('gas_fixed').value||0;
    var SCOP     = +el('scop').value||3.2;
    var el_p     = +el('elec_price').value||0.18;
    var pv       = Math.min(100,Math.max(0,+el('pv').value||0))/100;
    var invest   = +el('hp_invest').value||0;
    var subsidy  = +el('hp_subsidy').value||0;

    var gas_energy_kWh = gas_m3 * H;
    var useful_heat    = gas_energy_kWh * eff;

    var gas_energy_cost = gas_m3 * gas_p;
    var gas_fix_year    = gas_fix * 12;
    var gas_total       = gas_energy_cost + gas_fix_year;

    var hp_kwh       = (SCOP>0) ? (useful_heat / SCOP) : 0;
    var hp_paid_kwh  = hp_kwh * (1 - pv);
    var hp_total     = hp_paid_kwh * el_p;
    var savings      = Math.max(0, gas_total - hp_total);

    // UI render
    el('gas_kwh').textContent  = kwh(gas_energy_kWh);
    el('heat_kwh').textContent = kwh(useful_heat);
    el('hp_kwh').textContent   = kwh(hp_kwh);

    var rows = [
      ['Plyn: spotreba', gas_m3.toLocaleString('sk-SK') + ' m³'],
      ['Plyn: energia', kwh(gas_energy_kWh)],
      ['Kotol: účinnosť', Math.round(eff*100) + ' %'],
      ['Užitočné teplo', kwh(useful_heat)],
      ['Plyn: cena za m³', eur(gas_p) + ' / m³'],
      ['Plyn: variabilná zložka', eur(gas_energy_cost)],
      ['Plyn: fixná zložka (12×)', eur(gas_fix_year)],
      ['TČ: SCOP', SCOP.toFixed(1)],
      ['TČ: el. spotreba', kwh(hp_kwh)],
      ['FVE pokrytie', Math.round(pv*100) + ' %'],
      ['Elektrina: cena', eur(el_p) + ' / kWh'],
      ['Dotácia na TČ', subsidy>0 ? ('– ' + eur(subsidy)) : '0 €'],
      ['Investícia do TČ', invest>0 ? eur(invest) : '0 €']
    ];
    el('rows').innerHTML = rows.map(function(r){
      return '<tr><td>'+r[0]+'</td><td class="right">'+r[1]+'</td></tr>';
    }).join('');

    el('gas_total').textContent = eur(gas_total);
    el('hp_total').textContent  = eur(hp_total);
    el('savings').textContent   = eur(savings);

    // PAYBACK v UI: (investícia - dotácia) / úspora
    var netInvest = Math.max(0, invest - subsidy);
    var paybackTxt = '–';
    if (netInvest>0 && savings>0){
      var years = netInvest / savings;
      paybackTxt = years.toFixed(1).replace('.', ',') + ' roka/rokov';
    } else if (netInvest===0 && savings>0){
      paybackTxt = '0 (dotácia pokrýva investíciu)';
    }
    el('payback_ui').textContent = paybackTxt;
if (window.sendSpektraHeight) window.sendSpektraHeight();
    return { gas_total, hp_total, savings, invest, subsidy, netInvest, paybackTxt };
  }

  // PDF EXPORT – dočasne skryjeme tlačidlá, potom vrátime
  async function generatePDF(){
    const data = calc();

    const buttonsRow = document.getElementById('buttonsRow');
    const prevDisplay = buttonsRow.style.display;
    buttonsRow.style.display = 'none'; // skryť tlačidlá len pre export

    try{
      if (!window.jspdf || !window.html2canvas) {
        alert('Chýba knižnica pre export PDF. Obnovte stránku a skúste znova.');
        return;
      }

      const target = document.getElementById('exportArea');
      const canvas = await html2canvas(target, { scale: 2, useCORS: true });
      const imgData = canvas.toDataURL('image/png');

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 10;
      const contentW = pageW - margin*2;

      const imgW = contentW;
      const imgH = canvas.height * (imgW / canvas.width);

      if (imgH <= pageH - margin*2 - 24) {
        pdf.addImage(imgData, 'PNG', margin, margin, imgW, imgH);
      } else {
        let sY = 0;
        const pxPerMm = canvas.width / imgW;
        const pagePixelHeight = (pageH - margin*2 - 24) * pxPerMm;
        while (sY < canvas.height) {
          const sliceH = Math.min(pagePixelHeight, canvas.height - sY);
          const pageCanvas = document.createElement('canvas');
          pageCanvas.width = canvas.width;
          pageCanvas.height = sliceH;
          const ctx = pageCanvas.getContext('2d');
          ctx.drawImage(canvas, 0, sY, canvas.width, sliceH, 0, 0, canvas.width, sliceH);
          const pageImg = pageCanvas.toDataURL('image/png');
          if (sY>0) pdf.addPage();
          pdf.addImage(pageImg, 'PNG', margin, margin, imgW, (sliceH/pxPerMm));
          sY += sliceH;
        }
      }

      // vodotlač (ak zadaná URL)
      if (WATERMARK_URL) {
        try{
          const wm = await loadImage(WATERMARK_URL);
          pdf.setGState(new pdf.GState({opacity:0.08}));
          const wmW = pageW * 0.7;
          const wmH = wm.height * (wmW / wm.width);
          const x = (pageW - wmW)/2, y = (pageH - wmH)/2;
          const n = pdf.getNumberOfPages();
          for(let i=1;i<=n;i++){
            pdf.setPage(i);
            pdf.addImage(wm, 'PNG', x, y, wmW, wmH, undefined, 'FAST');
          }
          pdf.setGState(new pdf.GState({opacity:1}));
        }catch(e){ /* ignoruj chybu vodotlače */ }
      }

      // kontakt do päty
      const contact = `${COMPANY.name} • ${COMPANY.phone} • ${COMPANY.email} • ${COMPANY.web}`;
      pdf.setFont('helvetica','normal');
      pdf.setFontSize(9);
      const pages = pdf.getNumberOfPages();
      for(let i=1;i<=pages;i++){
        pdf.setPage(i);
        pdf.setTextColor(120);
        pdf.text(contact, margin, pageH - 6);
        pdf.setTextColor(0);
      }

      // pridaj aj návratnosť (text) na 1. stranu
      pdf.setPage(1);
      pdf.setFontSize(10);
      pdf.setTextColor(30);
      //pdf.text(`Výpočet úspory s tepelným čerpadlom oproti plynovému kotlu.`, margin, pageH - 12);
      pdf.setTextColor(0);

      pdf.save('Spektra_kalkulacka.pdf');
    } finally {
      buttonsRow.style.display = prevDisplay; // znovu zobraziť tlačidlá
    }
  }

  function loadImage(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = ()=>resolve(img);
      img.onerror = reject;
      img.src = url;
    });
  }

  // Handlery
  ['gas_m3','calorific','boiler_eff','gas_price','gas_fixed','scop','elec_price','pv','hp_invest','hp_subsidy'].forEach(function(id){
    var x = document.getElementById(id);
    x.addEventListener('input', calc);
    x.addEventListener('change', calc);
  });
  document.getElementById('pdfBtn').addEventListener('click', generatePDF);
  document.getElementById('resetBtn').addEventListener('click', function(){
    var def = {gas_m3:1500, calorific:10.5, boiler_eff:90, gas_price:0.75, gas_fixed:5, scop:3.2, elec_price:0.18, pv:20, hp_invest:0, hp_subsidy:0};
    Object.keys(def).forEach(function(k){
      var e = document.getElementById(k); e.value = def[k];
    });
    calc();
  });

  // prvý výpočet
  calc();
})();
</script>
  <script>
(function(){
  function sendHeight(){
    const h = Math.max(
      document.body.scrollHeight,
      document.documentElement.scrollHeight
    );
    window.parent.postMessage({ type:'spektra:resize', height: h }, '*');
  }

  // správa z rodiča – keď si vypýta aktuálnu výšku
  window.addEventListener('message', (e) => {
    if (e.data && e.data.type === 'spektra:requestHeight') sendHeight();
  });

  // po načítaní a s malým oneskorením (kvôli mobilom/iOS)
  window.addEventListener('load', () => {
    sendHeight();
    setTimeout(sendHeight, 150);
    setTimeout(sendHeight, 600);
  });

  // dynamické zmeny obsahu
  const ro = new ResizeObserver(() => sendHeight());
  ro.observe(document.body);

  // sprístupni funkciu aj globálne (aby ju vedel zavolať tvoj kalkulačný skript)
  window.sendSpektraHeight = sendHeight;
})();
</script>
</body>
</html>

